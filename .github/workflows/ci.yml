name: ğŸŒ± Arbore CI/CD

# DÃ©clenche le workflow sur push ou PR vers main/develop
on:
  push:
    branches: [ "main", "develop" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

env:
  GO_VERSION: "1.24"
  PYTHON_VERSION: "3.11"

jobs:
  # DÃ©tection des changements pour optimiser les builds
  changes:
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.filter.outputs.backend }}
      ai_generator: ${{ steps.filter.outputs.ai_generator }}
      ios_ui: ${{ steps.filter.outputs.ios_ui }}
      ios_ar: ${{ steps.filter.outputs.ios_ar }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v2
        id: filter
        with:
          filters: |
            backend:
              - 'ArboreBackend/**'
            ai_generator:
              - 'AiGenerator/**'
            ios_ui:
              - 'ArboreUi/**'
            ios_ar:
              - 'ArboreARkit/**'

  # Backend Go - Tests et Build
  backend:
    needs: changes
    if: needs.changes.outputs.backend == 'true'
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./ArboreBackend
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}
          cache-dependency-path: ArboreBackend/go.sum

      - name: ğŸ“¦ Download dependencies
        run: go mod download

      - name: ğŸ§ª Run tests
        run: go test -v -race -coverprofile=coverage.out ./...

      - name: ğŸ“Š Upload coverage
        uses: codecov/codecov-action@v3
        with:
          file: ./ArboreBackend/coverage.out
          flags: backend

      - name: ğŸ” Lint code
        uses: golangci/golangci-lint-action@v3
        with:
          working-directory: ArboreBackend
          version: latest

      - name: ğŸ—ï¸ Build binary
        run: CGO_ENABLED=0 GOOS=linux go build -o main .

  # AI Generator Python - Tests et Build  
  ai_generator:
    needs: changes
    if: needs.changes.outputs.ai_generator == 'true'
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./AiGenerator
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          pip install pytest black flake8

      - name: ğŸ¨ Check code formatting
        run: black --check . || echo "Code formatting issues found"

      - name: ğŸ” Lint code
        run: flake8 . --max-line-length=88 --extend-ignore=E203,W503 || echo "Linting issues found"

      - name: ğŸ§ª Run tests
        run: |
          if [ -d tests ]; then
            pytest -v
          else
            echo "No tests directory found, skipping tests"
          fi

  # iOS UI - Build (nÃ©cessite macOS)
  ios_ui:
    needs: changes
    if: needs.changes.outputs.ios_ui == 'true'
    runs-on: macos-latest
    defaults:
      run:
        working-directory: ./ArboreUi
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: 'latest-stable'

      - name: ğŸ“¦ Cache CocoaPods
        uses: actions/cache@v3
        with:
          path: ArboreUi/Pods
          key: ${{ runner.os }}-pods-${{ hashFiles('ArboreUi/Podfile.lock') }}
          restore-keys: |
            ${{ runner.os }}-pods-

      - name: ğŸ“¥ Install dependencies
        run: |
          if [ -f Podfile ]; then
            gem install cocoapods
            pod install --repo-update
          fi

      - name: ğŸ—ï¸ Build iOS App
        run: |
          if [ -f ArboreUi.xcworkspace ]; then
            xcodebuild -workspace ArboreUi.xcworkspace \
                       -scheme ArboreUi \
                       -destination 'platform=iOS Simulator,name=iPhone 15 Pro' \
                       -configuration Debug \
                       build
          else
            echo "Workspace not found, skipping build"
          fi

  # iOS AR Module - Build
  ios_ar:
    needs: changes
    if: needs.changes.outputs.ios_ar == 'true'
    runs-on: macos-latest
    defaults:
      run:
        working-directory: ./ArboreARkit
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: 'latest-stable'

      - name: ğŸ—ï¸ Build AR Module
        run: |
          if [ -f ArboreARkit.xcodeproj ]; then
            xcodebuild -project ArboreARkit.xcodeproj \
                       -scheme ArboreARkit \
                       -destination 'platform=iOS Simulator,name=iPhone 15 Pro' \
                       -configuration Debug \
                       build
          else
            echo "Project not found, skipping build"
          fi

  # Job de rÃ©sumÃ© final
  build_summary:
    needs: [changes, backend, ai_generator, ios_ui, ios_ar]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“Š Build Summary
        run: |
          echo "ğŸŒ± Arbore CI/CD Summary:"
          echo "Backend: ${{ needs.backend.result || 'skipped' }}"
          echo "AI Generator: ${{ needs.ai_generator.result || 'skipped' }}"
          echo "iOS UI: ${{ needs.ios_ui.result || 'skipped' }}"
          echo "iOS AR: ${{ needs.ios_ar.result || 'skipped' }}"
          
          # Ã‰chec si un job requis a Ã©chouÃ©
          if [[ "${{ needs.backend.result }}" == "failure" ]] || \
             [[ "${{ needs.ai_generator.result }}" == "failure" ]] || \
             [[ "${{ needs.ios_ui.result }}" == "failure" ]] || \
             [[ "${{ needs.ios_ar.result }}" == "failure" ]]; then
            echo "âŒ Un ou plusieurs builds ont Ã©chouÃ©"
            exit 1
          else
            echo "âœ… Tous les builds ont rÃ©ussi ou ont Ã©tÃ© ignorÃ©s"
          fi