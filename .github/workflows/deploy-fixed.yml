name: ðŸš€ Deploy

on:
  push:
    branches: [ "main" ]
    tags: [ "v*" ]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io

jobs:
  # Build et dÃ©ploiement des services
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # Backend Docker Build & Push
      - name: ðŸ—ï¸ Build & Push Backend
        run: |
          # Convertir le nom du repo en minuscules pour Docker Registry
          REPO_LOWER=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          
          if [ -f "ArboreBackend/Dockerfile" ]; then
            cd ArboreBackend
            docker build -t ${{ env.REGISTRY }}/${REPO_LOWER}-backend:latest .
            docker push ${{ env.REGISTRY }}/${REPO_LOWER}-backend:latest
            echo "Backend dÃ©ployÃ©"
          else
            echo "Dockerfile backend non trouvÃ©, crÃ©ation..."
            cat > ArboreBackend/Dockerfile << 'EOF'
          FROM golang:1.24-alpine AS builder
          WORKDIR /app
          COPY go.mod go.sum ./
          RUN go mod download
          COPY . .
          RUN CGO_ENABLED=0 GOOS=linux go build -o main .
          
          FROM alpine:latest
          RUN apk --no-cache add ca-certificates
          WORKDIR /root/
          COPY --from=builder /app/main .
          EXPOSE 8080
          CMD ["./main"]
          EOF
            cd ArboreBackend
            docker build -t ${{ env.REGISTRY }}/${REPO_LOWER}-backend:latest .
            docker push ${{ env.REGISTRY }}/${REPO_LOWER}-backend:latest
            echo "Backend dÃ©ployÃ© avec Dockerfile gÃ©nÃ©rÃ©"
          fi

      # AI Generator Docker Build & Push  
      - name: ðŸ¤– Build & Push AI Generator
        run: |
          # Convertir le nom du repo en minuscules pour Docker Registry
          REPO_LOWER=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          
          if [ -f "AiGenerator/Dockerfile" ]; then
            cd AiGenerator
            docker build -t ${{ env.REGISTRY }}/${REPO_LOWER}-ai:latest .
            docker push ${{ env.REGISTRY }}/${REPO_LOWER}-ai:latest
            echo "AI Generator dÃ©ployÃ©"
          else
            echo "Dockerfile AI non trouvÃ©, crÃ©ation..."
            cat > AiGenerator/Dockerfile << 'EOF'
          FROM python:3.11-slim
          WORKDIR /app
          COPY requirements.txt* ./
          RUN pip install fastapi uvicorn openai || pip install fastapi uvicorn
          COPY . .
          EXPOSE 8000
          CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8000"]
          EOF
            cd AiGenerator
            docker build -t ${{ env.REGISTRY }}/${REPO_LOWER}-ai:latest .
            docker push ${{ env.REGISTRY }}/${REPO_LOWER}-ai:latest
            echo "AI Generator dÃ©ployÃ© avec Dockerfile gÃ©nÃ©rÃ©"
          fi

      # Notification de succÃ¨s
      - name: ðŸŒ± Deployment Complete
        run: |
          # Convertir le nom du repo en minuscules pour l'affichage
          REPO_LOWER=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          echo "DÃ©ploiement Arbore terminÃ© avec succÃ¨s !"
          echo "Images disponibles :"
          echo "  - Backend: ${{ env.REGISTRY }}/${REPO_LOWER}-backend:latest"
          echo "  - AI Generator: ${{ env.REGISTRY }}/${REPO_LOWER}-ai:latest"
          echo ""
          echo "Pour utiliser ces images :"
          echo "  docker pull ${{ env.REGISTRY }}/${REPO_LOWER}-backend:latest"
          echo "  docker pull ${{ env.REGISTRY }}/${REPO_LOWER}-ai:latest"
